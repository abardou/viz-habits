<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0; }
    .hidden {
        display: none;
    }
    div.tooltip {
        color: #222;
        background-color: #fff;
        padding: .5em;
        text-shadow: #f5f5f5 0 1px 0;
        border-radius: 2px;
        opacity: 0.9;
        position: absolute;
    }
  </style>
</head>

<body>
  <script>
    // Svg variable
    var svg = d3.select("body").append("svg")
      .attr("width", 960)
      .attr("height", 500);
    
    // Tooltip div
    var tooltip = d3.select('body').append('div').attr('class', 'hidden tooltip');
    
    // Class for ring
    class Ring {
      /* Constructor for Ring
       * svg: the svg to draw in
       * tooltip: the tooltip to manipulate
       * id: the id of the ring (used in the svg)
       * cx: the absciss center of the ring
       * cy: the ordinate center of the ring
       * outrad: the outer radius of the ring
       * inrad: the inner radius of the ring
       * selcol: the select color of a ring segment
       * unselcol: the unselect color of a ring segment
       * data: the data displayed in the tooltip
       */
      constructor(svg, tooltip, id, cx, cy, outrad, inrad, selcol, unselcol, data) {
        this.svg = svg;
        this.tooltip = tooltip;
        this.id = id;
        this.cx = cx;
        this.cy = cy;
        this.outrad = outrad;
        this.inrad = inrad;
        this.selcol = selcol;
        this.unselcol = unselcol;
        this.data = data;
        
        let l = data.length;
        this.s_size = 1 / (l*Math.PI); // Space size
      	this.r_length = 2*Math.PI / l; // Size of arc + space
      	this.a_size = this.r_length - this.s_size; // Arc size
        this.selected = new Array(l).fill(true); // Selected segments
      }
      
      /* Return the color of the ith segment in the ring
       * i : data index, used to resolve color
       */
      color(i) {
        return this.selected[i] ? this.selcol : this.unselcol;
      }
      
      /* Called when the mouse moves on a ring segment
       * d: data value, included in the tooltip
       */
      mouse_move(d, pathObject) {
        var mousePosition = d3.mouse(pathObject);
        this.tooltip.classed('hidden', false)
          .attr('style', 'left:' + (mousePosition[0] + 15 + this.cx) +
                'px; top:' + (mousePosition[1] - 35 + this.cy) + 'px')
          .html(d);
      }
      
      /* Called when the mouse is over a ring segment
       * i: data index, used to resolve color
       */
      mouse_over(i, pathObject) {
        var col = this.selected[i] ? this.unselcol : this.selcol;
        d3.select(pathObject).style("fill", col)
      }
      
      /* Called when the mouse is out of a ring segment
       * i: data index, used to resolve color
       */
      mouse_out(i, pathObject) {
        var col = this.color(i);
        d3.select(pathObject).transition().duration(400).style("fill", col)
        this.tooltip.classed('hidden', true);
      }
      
      /* Called when a ring segment is clicked
       * i: data index, used to update intern state
       */
      on_click(i, pathObject) {
        this.selected[i] = !this.selected[i];
        var col = this.color(i);
        d3.select(pathObject).style("fill", col)
      }
      
      /* Draw a ring segment
       * i: data index, used to compute angles
       */
      draw_arc(i) {
        return d3.arc()
        .innerRadius(this.inrad)
        .outerRadius(this.outrad)
        .startAngle(i * this.r_length)
        .endAngle(i * this.r_length + this.a_size);
      }
      
      /* Return the selected arcs
       */
      get selection() {
        return this.selected;
      }
      
      /* Draw the whole ring, need to be called by the user
       */
      draw() {
        var that = this
        // var seg = this.svg.selectAll(this.id).data(this.data);
        this.svg.selectAll(this.id).data(this.data).enter()
         .append("path")
         .attr("transform", "translate("+that.cx+", "+that.cy+")")
         .attr("d", function(d, i) { return that.draw_arc(i)(); })
         .attr("fill", function(d, i) { return that.color(i); })
         .on('mousemove', function(d) { that.mouse_move(d, this) })
         .on('mouseout', function(d,i) { that.mouse_out(i, this) })
         .on("mouseover", function(d, i) {that.mouse_over(i, this)})
         .on("click", function(d, i) {that.on_click(i, this)})
      }
    }
    
    // Tooltip for days
    tt1 = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"]
    
    // Tooltip for hours
    tt2 = [...Array(24).keys()]
    for (var i = 0; i < tt2.length; i++) tt2[i] = i+(i > 12 ? -12 : 0)+(i > 12 ? "pm" : "am")
    
    // Granularity for minutes
    g_min = 5
    // Tooltip for minutes
    tt3 = [...Array(60/g_min).keys()]
    for (var i = 0; i < tt3.length; i++) tt3[i] = (g_min > 1 ? (i*g_min)+"-"+(i+1)*g_min : i)
    
    // Rings
    var r1 = new Ring(svg, tooltip, "ring_1", 480, 250, 132, 112, "#374d7c", "#ddd", tt1);
    var r2 = new Ring(svg, tooltip, "ring_2", 480, 250, 106, 86, "#46edc8", "#ddd", tt2);    
    var r3 = new Ring(svg, tooltip, "ring_3", 480, 250, 80, 60, "#fdf289", "#ddd", tt3);
    
    r1.draw();
    r2.draw();
    r3.draw();
  </script>
</body>
